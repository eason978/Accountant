# Accountant Product Requirements Document (PRD)

## 1. Goals and Background Context

#### **Goals**

本文件旨在定義「Accountant」專案第一版 (MVP) 的需求，以達成以下關鍵成果：

*   交付一個能穩定運作的 MVP，核心功能是將 PDF 及圖片格式的財務報表，自動化處理並匯入 Firefly III。
*   為使用者大幅節省手動記帳的時間，並顯著提升其帳務紀錄的準確性與即時性。
*   透過獨特的「訓練模式」，賦予使用者個人化調校 AI 辨識核心的能力。
*   在 Firefly III 社群中建立良好聲譽，並獲取初期的活躍使用者。

#### **Background Context**

目前，許多注重細節的理財者，仍需花費大量時間從不統一、非結構化的文件（如銀行 PDF 對帳單、消費截圖）中手動謄寫交易資料。這個過程不僅耗時且易出錯，而現有的解決方案（如銀行 API 或 CSV 匯入）又存在隱私、覆蓋率或功能上的不足。

為此，我們提出 Accountant 專案。它將作為著名開源記帳軟體 Firefly III 的一個智慧前端與自動化引擎。其核心是利用 AI 技術，辨識並解析使用者上傳的各類帳單文件，再透過一個可由使用者「訓練」的對應與校正系統，將交易資料精準、可靠地匯入 Firefly III，從而徹底解決手動記帳的痛點。

#### **Change Log**

| Date       | Version | Description                          | Author              |
| :--------- | :------ | :----------------------------------- | :------------------ |
| 2025-08-29 | 1.0     | 根據已批准的專案簡報，建立 PRD 初始草稿。 | John, Product Manager |

---

## 2. Requirements

#### **Functional Requirements**

*   **FR1:** 系統必須提供使用者註冊與登入功能。
*   **FR2:** 使用者必須能夠安全地設定並儲存其 Firefly III 實例的 API 連接資訊（URL 和個人存取權杖）。
*   **FR3:** 使用者必須能透過 Web 介面，上傳 PDF（包括需要密碼的檔案）和圖片（JPG, PNG）格式的財務文件。
*   **FR4:** 系統必須能呼叫 AI 服務，從上傳的文件中解析並提取出結構化的交易列表（包含日期、描述、金額等）。
*   **FR5:** 系統必須提供一個交易對應介面 (Mapping UI)，讓使用者可以檢視提取出的交易，並將其手動對應到 Firefly III 的帳戶、分類和標籤。
*   **FR6:** 使用者確認後，系統必須能將對應好的交易資料，透過 API 匯入到使用者的 Firefly III 實例中。
*   **FR7:** 每一筆被匯入的交易，都必須包含一個欄位，用以追溯其原始的文字來源（例如：`web/富邦信用卡202504對帳單/優食-星巴克`）。
*   **FR8:** 系統必須提供一個基礎的訓練模式，允許使用者儲存一組針對某特定帳單版面的自訂規則/提示。

#### **Non-Functional Requirements**

*   **NFR1:** 在 10 個活躍使用者的負載下，系統的雲端基礎設施（GCP + Supabase）成本必須維持在永久免費方案的額度內。
*   **NFR2:** 應用程式的使用者介面必須是響應式的 (Responsive)，確保在桌面和行動裝置的瀏覽器上都有一致且可用的體驗。
*   **NFR3:** 系統必須透過加密方式，安全地儲存所有敏感資料，特別是使用者的密碼和 Firefly III 的 API 權杖。
*   **NFR4:** 對於一份典型的對帳單，從上傳到 AI 解析完成的時間，應控制在 60 秒以內，以確保良好的使用者體驗。
*   **NFR5:** 系統的技術架構，必須考慮到未來在 ARM SBC 硬體上部署的兼容性。

---

## 3. User Interface Design Goals

#### **Overall UX Vision**

我們的 UX 願景是：**清晰、高效、賦予使用者掌控感**。

介面應該給人專業工具的感覺，而非玩具。所有設計都應以提升資訊的清晰度和操作的流暢性為最優先，無縫地引導使用者走完 `上傳 -> 對應 -> 匯入` 的核心流程。整個體驗旨在建立使用者對我們系統的信心與信任。

#### **Key Interaction Paradigms**

*   **以工作流程為驅動 (Workflow-driven):** 介面將圍繞核心任務來組織，一步步清晰地引導使用者，避免迷失方向。
*   **「審核與修正」模型 (Review and Correct Model):** 我們不要求使用者從零開始輸入資料，而是由系統（AI）先呈現它辨識出的結果，再由使用者進行確認或修正。這種互動模式對使用者的心智負擔較小。
*   **漸進式揭露 (Progressive Disclosure):** 預設隱藏複雜性。只在當前步驟顯示必要的資訊和操作。進階選項（如編輯訓練規則）應該要易於找到，但不能干擾主要的工作流程。

#### **Core Screens and Views**

從產品角度看，為實現 MVP 價值所需的最關鍵畫面包括：

*   **登入/註冊畫面:** 標準的使用者身份驗證介面。
*   **儀表板 / 上傳畫面:** 作為應用的中心樞紐。使用者可以在此透過拖放或點擊來上傳文件，開始一個新的匯入任務。此畫面可能也會顯示近期的匯入歷史。
*   **交易對應/審核畫面:** 這是最核心的「工作台」畫面。它可能會以列表形式，清晰地展示所有從文件中提取出的交易，並在旁邊提供表單，讓使用者能方便地進行分類、加標籤等對應操作。
*   **設定畫面:** 用於管理 Firefly III API 連接資訊，以及未來其他使用者偏好設定的地方。

#### **Accessibility: WCAG AA**

我們設定的目標是，讓產品符合 WCAG 2.1 AA 標準。這能確保我們的應用程式可被更廣泛的使用者（包括有視覺或操作障礙的使用者）順利使用，這也是現代 Web 應用的基本要求。

#### **Branding**

在沒有特定品牌指南的情況下，我建議採用一種簡潔、專注於數據、值得信賴的視覺風格。

*   **風格:** 專業、乾淨、現代。
*   **色調:** 建議使用能喚起信任感和穩定感的色系（如藍色、灰色），並搭配清晰、易讀的字體。
*   **應避免:** 避免使用過於花俏、卡通化或會分散使用者注意力的視覺元素。品牌給人的感覺應該像一個可靠的財務工具。

#### **Target Device and Platforms: Web Responsive**

我們的目標是開發一個響應式的 Web 應用，它必須能在主流的桌面瀏覽器（如 Chrome, Safari, Edge）和行動裝置瀏覽器上，都提供良好、一致的使用體驗。

---

## 4. Technical Assumptions

#### **Repository Structure: Monorepo**

我們將採用 Monorepo (單一程式碼庫) 的結構。這將便於前端與後端專案之間共享程式碼、類型定義和設定，從而提升開發效率和一致性。

#### **Service Architecture**

我們將採用一個現代化的、以 Serverless 為核心的混合雲架構：

*   **前端應用:** 一個響應式的 Web 應用（建議使用 **React/Next.js** 或 **Vue/Nuxt.js**），將被部署為一個 Serverless 服務（例如在 **GCP Cloud Run** 上）。
*   **後端服務:** 一個輕量級的單體式 (Monolith) 後端（建議使用 **Python/FastAPI**），負責處理所有核心業務邏輯。它同樣會被部署在 **GCP Cloud Run** 上。
*   **資料庫與使用者驗證:** 完全由 **Supabase** 提供。這讓我們能免費使用一個全功能的 **PostgreSQL** 資料庫和成熟的身份驗證服務。
*   **AI 服務:** 作為一個外部依賴，呼叫 **GCP Cloud Vision API** 來進行文件解析。
*   **非同步任務:** 使用 **GCP Cloud Tasks** 來管理和觸發如文件處理這類耗時的背景工作。

#### **Testing Requirements**

我們將採取一個務實的測試策略，專注於為 MVP 提供最高的投資報酬率：

*   **單元測試 (Unit Tests):** 針對後端服務中所有關鍵的、獨立的業務邏輯（如資料轉換、規則處理等）編寫單元測試。
*   **整合測試 (Integration Tests):** 針對後端服務與所有外部 API（Firefly III, Supabase, GCP Vision）的串接點編寫整合測試。這將確保我們與第三方服務的互動符合預期。
*   **暫不考慮:** 端對端 (End-to-End) 測試和完整的使用者介面自動化測試，在 MVP 階段將被視為範疇外，以加快開發速度。

#### **Additional Technical Assumptions**

*   我們將使用 **Docker** 對應用程式進行容器化，以確保開發、測試和生產環境的一致性，並為未來在任何地方（雲端或本地 ARM 硬體）的部署提供便利。
*   所有技術選擇都必須嚴格遵守「MVP 階段零成本」的核心限制。

---

## 5. Epic List

*   **Epic 1: 專案基礎與核心連接 (Foundation & Core Connection)**
    *   **目標:** 建立專案的技術基礎設施（包含程式碼庫、CI/CD、雲端服務設定），並讓使用者能夠完成註冊、登入，以及成功連接到他們自己的 Firefly III 實例。
*   **Epic 2: 文件上傳與 AI 解析 (Document Upload & AI Parsing)**
    *   **目標:** 讓使用者能夠上傳一份財務文件（PDF 或圖片），並在介面上看到經由 AI 服務解析後，提取出的結構化交易資料。
*   **Epic 3: 交易對應與匯入 (Transaction Mapping & Import)**
    *   **目標:** 讓使用者能夠審核、分類和對應由 AI 解析出的交易資料，並將其成功地匯入到他們的 Firefly III 實例中，完成核心的端到端工作流程。
*   **Epic 4: 基礎訓練模式與易用性 (Basic Training Mode & Usability)**
    *   **目標:** 實作基礎的「訓練模式」，允許使用者儲存一組自訂規則，以提升未來從特定帳單中匯入資料的準確性，並對整體流程進行初步的易用性優化。

---

## 6. Epic Details

### Epic 1: 專案基礎與核心連接 (Foundation & Core Connection)

**Epic 目標:**
此 Epic 的目標是為整個 Accountant 應用程式奠定穩固的技術基石。在此 Epic 完成時，我們將擁有一個可自動化部署的專案結構、一個能讓使用者安全管理其帳戶的系統，以及應用程式與使用者個人 Firefly III 實例之間至關重要的通訊能力。這為後續所有功能的開發，提供了最基礎的使用者與系統上下文。

#### **Story 1.1: 專案設定與初始部署**

*   **身為** 開發團隊，
*   **我想要** 設定好包含前端和後端的 Monorepo 專案結構，配置好基礎的 CI/CD 自動化部署流程，
*   **以便** 我們有一個穩固、可自動化、可持續整合的開發基礎。

**驗收條件 (Acceptance Criteria):**
1.  一個 Git Monorepo 程式碼庫已被建立。
2.  Repo 內需包含一個前端 App 和一個後端 App 的套件/資料夾。
3.  一個基礎的 CI/CD 流程（如 GitHub Actions）已被設定，會在推送到主分支時自動觸發。
4.  CI/CD 流程能自動將前端和後端應用，分別部署到 GCP Cloud Run。
5.  部署後的前端 URL，能顯示一個簡單的「Hello World」或專案預留位置頁面。
6.  部署後的後端 URL，有一個 `/health` 的健康檢查路由，訪問時應回傳 200 OK 狀態碼。

#### **Story 1.2: 使用者註冊與登入**

*   **身為** 一位新使用者，
*   **我想要** 使用我的電子郵件和密碼來註冊一個新帳戶，並能在之後成功登入，
*   **以便** 我可以安全地使用這個應用程式。

**驗收條件 (Acceptance Criteria):**
1.  系統提供一個公開的頁面，其中包含使用者註冊和登入的表單。
2.  使用者可以使用有效的電子郵件和密碼進行註冊，其資料會被儲存在 Supabase 資料庫中。
3.  成功註冊後，使用者會被自動登入，並被重新導向到一個私有的儀表板頁面。
4.  已註冊的使用者可以登出，並能使用其憑證重新登入。
5.  系統應阻止使用已被註冊的電子郵件，來建立新的帳戶。
6.  所有與身份驗證相關的通訊，都必須使用 HTTPS 加密。

#### **Story 1.3: Firefly III 連接管理**

*   **身為** 一位已登入的使用者，
*   **我想要** 在一個安全的介面中，儲存並能更新我個人 Firefly III 實例的連接資訊（API URL 和個人存取權杖），
*   **以便** Accountant 應用程式能與我的個人財務數據來源進行通訊。

**驗收條件 (Acceptance Criteria):**
1.  系統提供一個只有登入使用者才能訪問的「設定」頁面。
2.  「設定」頁面中，有一個包含「Firefly III URL」和「個人存取權杖」欄位的表單。
3.  當使用者儲存表單時，應用程式必須在將「個人存取權杖」存入資料庫前，對其進行加密。
4.  儲存後，應用程式會自動發起一個測試性的 API 請求（例如，請求 Firefly III 的 `/api/v1/about` 路由），以驗證連接資訊的有效性。
5.  介面需根據測試請求的結果，向使用者顯示清晰的「連接成功」或「連接失敗」的訊息。
6.  使用者可以隨時回到設定頁面，查看已儲存的 URL（但權杖本身應被遮蔽，如 `••••••••`），並能更新這些資訊。

### Epic 2: 文件上傳與 AI 解析 (Document Upload & AI Parsing)

**Epic 目標:**
基於 Epic 1 已建立的使用者和系統基礎，此 Epic 的目標是讓使用者能透過 Web 介面，實際地上傳一份財務文件。系統將會把這份文件發送到外部 AI 服務進行光學辨識 (OCR) 與解析，並首次將提取出的結構化交易資料，呈現在使用者眼前。這個階段的完成，將是產品核心價值的第一次重要驗證。

#### **Story 2.1: 基礎文件上傳介面**

*   **身為** 一位已登入的使用者，
*   **我想要** 在儀表板上傳我的財務文件（PDF 或圖片），
*   **以便** 我可以將我的對帳單提交給系統進行處理。

**驗收條件 (Acceptance Criteria):**
1.  使用者登入後的主儀表板頁面，需包含一個檔案上傳元件（例如，一個拖放區域或檔案選擇按鈕）。
2.  該元件應限制使用者只能上傳 PDF, JPG, PNG 類型的檔案。
3.  選擇檔案後，介面需顯示已選的檔名，並提供一個「開始匯入」的按鈕。
4.  點擊「開始匯入」後，檔案會被成功地上傳到一個安全的暫存位置（如 Supabase Storage）。
5.  上傳成功後，系統會觸發一個背景任務來處理此文件，並將使用者導向到一個「處理中/審核」的頁面。
6.  介面需顯示適當的載入中提示，並能優雅地處理上傳失敗的錯誤（如檔案過大、格式錯誤）。

#### **Story 2.2: AI 文件解析與資料提取**

*   **身為** 系統，
*   **我想要** 在接收到一個新上傳的文件後，將其發送到指定的 AI 服務進行解析，並從回傳結果中提取出結構化的交易資料，
*   **以便** 應用程式能將非結構化的文件，轉化為機器可讀的資料。

**驗收條件 (Acceptance Criteria):**
1.  檔案上傳成功後，一個對應的背景處理任務會被成功觸發。
2.  該背景任務能從暫存位置讀取到上傳的檔案。
3.  該背景任務能正確地帶著檔案資料，呼叫外部 AI 服務的 API。
4.  系統能成功處理 AI 服務回傳的結果，解析出可能的交易列表。
5.  提取出的原始資料（如包含日期、描述、金額的交易列表）會被儲存到資料庫中，並與該使用者及本次匯入任務關聯。
6.  系統能正確處理來自 AI 服務的潛在錯誤（如 API 金鑰錯誤、處理失敗），並將其記錄下來。
7.  (For Story 2.3) 如果上傳的 PDF 有密碼保護，背景任務需能接收一個密碼，以便在後續步驟中解密並處理檔案。

#### **Story 2.3: 顯示已解析的交易資料**

*   **身為** 一位已登入的使用者，
*   **我想要** 在審核頁面上，看到從我上傳的文件中提取出來的所有交易，
*   **以便** 我可以確認 AI 解析的結果是否正確。

**驗收條件 (Acceptance Criteria):**
1.  「審核」頁面會輪詢後端，以獲取文件處理任務的狀態。
2.  當處理完成後，頁面會以一個清晰的表格格式，顯示所有提取出的交易。
3.  表格中應包含如日期、描述、金額等關鍵的提取資料欄位。
4.  如果文件是一個需要密碼的 PDF，且系統正在等待密碼，介面應顯示一個密碼輸入框，而非交易表格。
5.  在使用者輸入正確的密碼後，後端處理流程會繼續，且介面會隨之更新並顯示提取出的交易。
6.  介面需顯示一個清楚的摘要，例如：「我們在您的文件中找到了 15 筆交易。」

### Epic 3: 交易對應與匯入 (Transaction Mapping & Import)

**Epic 目標:**
此 Epic 的目標是賦予使用者處理 AI 解析結果的能力，並完成整個自動化記帳的閉環。基於 Epic 2 產出的解析資料，使用者將能透過一個直觀的介面，來審核、修正並豐富這些交易資料（如指定帳戶、分類）。最終，此 Epic 將實現將這些乾淨、準確、經使用者確認的資料，成功地推送到使用者的 Firefly III 實例中，首次完整地交付我們產品的核心價值。

#### **Story 3.1: 交易審核與編輯**

*   **身為** 一位已登入的使用者，
*   **我想要** 審核由 AI 提取出的交易列表，並能編輯 AI 可能解析錯誤的欄位（如描述或金額），
*   **以便** 我能確保在匯入前，所有資料都是 100% 準確的。

**驗收條件 (Acceptance Criteria):**
1.  在交易審核頁面的表格中，每一筆交易的欄位都應是可編輯的。
2.  點擊一個欄位（如「描述」）後，它會變成一個可供輸入的文字框。
3.  使用者可以修改欄位中的文字或數字。
4.  使用者可以將整筆交易刪除，以處理無關或重複的記錄。
5.  介面需清楚地標示出哪些交易行或欄位，是經過使用者手動修改的。

#### **Story 3.2: 欄位對應至 Firefly III 屬性**

*   **身為** 一位已登入的使用者，
*   **我想要** 為每一筆交易，對應到我在 Firefly III 中設定好的帳戶（來源與目標）、分類和標籤，
*   **以便** 我匯入的帳務，在 Firefly III 中是井然有序、正確歸類的。

**驗收條件 (Acceptance Criteria):**
1.  審核介面的表格中，需包含「來源帳戶」、「目標帳戶」、「分類」和「標籤」等欄位。
2.  「來源帳戶」的下拉選單中，需能顯示從使用者 Firefly III 實例中，透過 API 獲取的所有資產帳戶 (Asset accounts)。
3.  「目標帳戶」的下拉選單中，需能顯示所有的支出帳戶 (Expense accounts)。
4.  「分類」的下拉選單中，需能顯示所有的可用分類。
5.  「標籤」的輸入框，需能讓使用者從現有標籤中選擇，或建立新的標籤。
6.  系統需支援批次編輯功能，允許使用者選取多筆交易，一次性地為它們設定相同的帳戶或分類。

#### **Story 3.3: 最終匯入至 Firefly III**

*   **身為** 一位已登入的使用者，
*   **我想要** 點擊一個最終的「匯入」按鈕，將所有我審核並對應好的交易，一次性地推送到我的 Firefly III 實例中，
*   **以便** 我能完成記帳，而完全不需要在 Firefly III 的介面中手動輸入任何東西。

**驗收條件 (Acceptance Criteria):**
1.  審核頁面上有一個顯眼的「匯入 X 筆交易」按鈕。
2.  點擊該按鈕後，所有準備好的結構化交易資料，會被發送到後端進行處理。
3.  後端服務會遍歷所有交易資料，並依序呼叫 Firefly III 的 API，來建立每一筆交易。
4.  系統能正確處理來自 Firefly III API 的潛在錯誤（如無效資料、連接失敗），並將錯誤訊息回報給使用者。
5.  匯入流程結束後，介面需顯示一個清晰的成功訊息，例如：「已成功匯入 15 筆交易至 Firefly III。」
6.  使用者可以立刻前往他的 Firefly III 實例，並看到剛剛建立好的所有交易，其帳戶、分類、標籤和原始資料來源等欄位，均應正確無誤。

### Epic 4: 基礎訓練模式與易用性 (Basic Training Mode & Usability)

**Epic 目標:**
在核心的端到端工作流程已可運作的基礎上，此 Epic 的目標是交付我們產品的關鍵競爭優勢：可訓練的 AI。我們將允許使用者將他們手動修正與對應的結果，儲存為一條可重複使用的規則。這能讓系統在每次使用後都變得更聰明，將應用程式從一個單次的便利工具，轉變為一個能自我完善的個人化財務助理，從而極大地提升產品價值並鼓勵使用者長期使用。

#### **Story 4.1: 規則建議與儲存**

*   **身為** 一位已登入的使用者，
*   **我想要** 在我成功地對應並匯入完一種類型的對帳單後，系統能提示我將這次的對應關係，儲存為一條可重複使用的「規則」，
*   **以便** 我下次上傳同類型的對帳單時，就不用再重複做一樣的對應工作。

**驗收條件 (Acceptance Criteria):**
1.  在一次成功的匯入任務完成後，介面需顯示一個提示，例如：「您是否想將這次的對應關係，儲存為一條給『富邦信用卡』帳單的未來規則？」
2.  使用者可以為這條規則，設定一個便於自己識別的名稱（例如：「我的富邦卡規則」）。
3.  系統會分析使用者剛剛所做的對應（例如，將包含「UBER」的交易，對應到「交通」分類），並將其轉換為一條基礎的規則。
4.  點擊「儲存規則」後，這條規則/提示會被儲存到資料庫中，並與該使用者帳戶關聯。
5.  MVP 階段的規則，將專注於處理「交易描述中的關鍵字」與「目標分類/帳戶」之間的對應關係。
6.  使用者可以選擇忽略提示，而不儲存任何規則。

#### **Story 4.2: 將已存規則應用於新匯入任務**

*   **身為** 一位已登入的使用者，
*   **我想要** 當我上傳一份新的文件時，系統能自動套用我先前儲存的規則，來預先填寫好對應欄位，
*   **以便** 系統能自動地為我分類新的交易，進一步節省我的時間與精力。

**驗收條件 (Acceptance Criteria):**
1.  當使用者上傳新文件時，系統需能識別出可應用的已存規則（在 MVP 階段，這可以是一個讓使用者手動選擇的下拉選單，例如：「要套用哪一條規則？」）。
2.  系統會將使用者選擇的規則（或自動識別的規則），在 AI 解析階段，一併提交給 AI 服務，以獲得更精準的初始結果。
3.  (替代方案) 或者，規則可以在 AI 初步解析後，由後端程式套用。系統會遍歷所有交易，若描述符合規則（如包含「UBER」），則自動填入對應的分類（如「交通」）。
4.  在「交易審核」畫面上，那些被規則自動填寫的欄位，需要有清楚的視覺標示（例如，一個小圖示或不同的顏色）。
5.  使用者依然可以手動修改任何由規則預先填寫的對應結果。

#### **Story 4.3: 基礎規則管理**

*   **身為** 一位已登入的使用者，
*   **我想要** 查看，並能刪除我先前儲存的所有規則，
*   **以便** 我可以管理我的規則庫，移除那些不再需要的規則。

**驗收條件 (Acceptance Criteria):**
1.  在「設定」頁面中，有一個新的區塊，名為「我的規則」。
2.  這個區塊會以列表形式，顯示出使用者儲存的所有規則的名稱。
3.  使用者可以從列表中，將一條規則刪除。
4.  為了控制 MVP 的範疇，「編輯」規則的功能將暫不提供。使用者若想修改一條規則，需要先將其刪除，再重新建立一條新的。
