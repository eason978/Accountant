---
epic: 5
story-id: 1
title: "Trigger Final Import to Firefly III and Handle Results"
status: "Draft"
---

### 1. Story

As a user who has finished reviewing and mapping my transactions, I want to click a single "Import" button to send them to Firefly III and see a clear success or failure message.

### 2. Acceptance Criteria

1.  A primary "Import to Firefly III" button is available on the transaction review page.
2.  Clicking this button calls a new backend endpoint: `POST /api/v1/import-jobs/{jobId}/import`.
3.  The backend fetches all `StagedTransaction` records for the job that have been fully mapped by the user.
4.  The backend retrieves the user's Firefly III credentials and decrypts the token.
5.  For each valid staged transaction, the backend calls the Firefly III API (`POST /api/v1/transactions`) to create the transaction.
6.  If all transactions are imported successfully, the backend updates the `ImportJob` status to `completed`.
7.  If any transaction fails to import, the process stops, the `ImportJob` status is updated to `failed`, and the specific error from Firefly III is logged.
8.  The frontend displays a success message and perhaps navigates back to the dashboard upon successful completion.
9.  The frontend displays a specific error message if the import process fails.

### 3. Dev Notes

#### Previous Story Insights
*   This is the final step in the core user workflow, bringing together all previous epics.

#### Data Models
*   **`ImportJob`**: The status of this record will be updated to `completed` or `failed`.
*   **`StagedTransaction`**: The system will read from this table to get the data to be imported.

#### API Specifications
*   **`POST /import-jobs/{jobId}/import`**: This new endpoint orchestrates the final import process.
    *   `[Source: architecture.md#5.1 REST API Specification (OpenAPI)]`
*   **Firefly III API**: The backend will make heavy use of the `POST /api/v1/transactions` endpoint on the user's instance.
    *   `[Source: architecture.md#7.1 API: Firefly III API]`

#### Component Specifications
*   **Transaction Review Page**: A primary button will be added to trigger the import.
    *   The page will need to handle loading states while the import is in progress and display final success/error messages, likely using a Modal or Snackbar.
    *   `[Source: front-end-spec.md#4.1 Key Screen Layouts]`

#### File Locations
*   **Frontend Page**: `apps/web/src/app/jobs/[jobId]/page.tsx` will be updated to include the import button and result handling.
*   **Backend API Endpoint**: `apps/api/routers/import_jobs.py` will be updated with the `POST /{jobId}/import` endpoint.

#### Testing Requirements
*   **Backend (Pytest)**:
    *   Write unit tests for the `.../import` endpoint.
    *   Mock the database calls and the external Firefly III API calls.
    *   Test the success case where all transactions are imported and the job status is updated.
    *   Test the failure case where one transaction fails, ensuring the process stops and the job status is marked as failed.
*   **Frontend (Jest/RTL)**:
    *   Test the click handler for the import button.
    *   Mock the backend API call and test the display of success and error messages.

### 4. Tasks / Subtasks

1.  **Backend: Create API Endpoint (AC: 2)**
    *   [ ] In `apps/api/routers/import_jobs.py`, implement the `POST /{jobId}/import` endpoint.
2.  **Backend: Implement Import Logic (AC: 3, 4, 5)**
    *   [ ] In the endpoint, fetch all fully mapped `StagedTransaction`s for the job.
    *   [ ] Fetch the user's Firefly III connection and decrypt the token.
    *   [ ] Loop through the staged transactions. For each one, construct the payload for the Firefly III API and make the `POST` request.
3.  **Backend: Handle Success and Failure (AC: 6, 7)**
    *   [ ] Wrap the loop in a try/except block.
    *   [ ] If the loop completes without error, update the `ImportJob` status to `completed`.
    *   [ ] If any API call fails, catch the exception, update the `ImportJob` status to `failed` with the error message, and stop processing.
4.  **Frontend: Add Trigger and Handle Feedback (AC: 1, 8, 9)**
    *   [ ] Add the "Import to Firefly III" button to the review page.
    *   [ ] Implement the `onClick` handler to call the new backend endpoint.
    *   [ ] Display a loading indicator while the import is in progress.
    *   [ ] On success, show a success message (e.g., Snackbar) and redirect to the dashboard.
    *   [ ] On failure, show a descriptive error message.
5.  **Write Tests**
    *   [ ] Implement backend unit tests for the import orchestration.
    *   [ ] Implement frontend unit tests for the import button and feedback states.

### 5. QA Results
*   *Pending*
