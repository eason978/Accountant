---
epic: 3
story-id: 4
title: "Load Mapping Data from Firefly III"
status: "Draft"
---

### 1. Story

As a user, I want the mapping dropdowns to be populated with the actual accounts and categories from my Firefly III instance, so that I can accurately map my transactions.

### 2. Acceptance Criteria

1.  New backend proxy endpoints are created: `GET /api/v1/firefly/accounts` and `GET /api/v1/firefly/categories`.
2.  When these endpoints are called, the backend retrieves the user's `FireflyConnection` details from the database.
3.  The backend decrypts the `encrypted_access_token`.
4.  The backend makes authenticated API calls to the user's Firefly III instance to fetch the list of accounts and categories.
5.  The frontend `TransactionTable` component calls these new proxy endpoints to get the data for the dropdowns.
6.  The "Source Account", "Destination Account", and "Category" dropdowns are populated with the data fetched from the proxy endpoints.
7.  When a user selects a value in one of the mapping dropdowns, the `user_mappings` field for that `StagedTransaction` is updated in the database via the existing `PUT /staged-transactions/{transactionId}` endpoint.

### 3. Dev Notes

#### Previous Story Insights
*   This story builds on the UI from 3.3 and the update logic from 3.2. It requires the secure connection established in 1.4.

#### Data Models
*   **`FireflyConnection`**: The backend will read from this table to get the URL and encrypted token.
*   **`StagedTransaction`**: The `user_mappings` field will now be actively updated when the user makes a selection.

#### API Specifications
*   **`GET /firefly/accounts` & `GET /firefly/categories`**: These new proxy endpoints are the core of the backend work. They must handle fetching the user's connection, decrypting the token, calling the external Firefly III API, and then relaying the response.
    *   `[Source: architecture.md#5.1 REST API Specification (OpenAPI)]`
*   **`PUT /staged-transactions/{transactionId}`**: This existing endpoint will be used to save the user's mapping selections.

#### Component Specifications
*   **TransactionTable**: This component will be significantly updated.
    *   It will now be responsible for fetching the data for the select options when it mounts.
    *   The `Select` components in the mapping columns will be enabled and populated with the fetched data.
    *   The `processRowUpdate` logic will be updated to include changes to the `user_mappings` field.

#### File Locations
*   **Frontend Component**: `apps/web/src/components/review/TransactionTable.tsx` will be modified.
*   **Backend API Endpoints**: The `apps/api/routers/firefly.py` file (from Story 1.4) will be updated to include the new `GET` endpoints for accounts and categories.
*   **Backend Decryption**: The decryption logic created in 1.4 will be reused.

#### Testing Requirements
*   **Backend (Pytest)**:
    *   Write unit tests for the new proxy endpoints.
    *   Mock the database call to fetch the connection and the external call to Firefly III.
    *   Ensure the decryption logic is called.
    *   Test that the endpoints correctly relay the data.
*   **Frontend (Jest/RTL)**:
    *   Update tests for `TransactionTable.tsx`.
    *   Mock the API calls to the new proxy endpoints.
    *   Verify that the `Select` components are populated with the mock data.
    *   Simulate a user selecting an option and verify that the update API is called with the correct `user_mappings` data.

### 4. Tasks / Subtasks

1.  **Backend: Create Proxy Endpoints (AC: 1, 2, 3, 4)**
    *   [ ] In `apps/api/routers/firefly.py`, create the `GET /accounts` and `GET /categories` endpoints.
    *   [ ] In each endpoint, add logic to:
        *   Get the current `user_id` from the JWT.
        *   Fetch the user's `FireflyConnection` record.
        *   Decrypt the access token.
        *   Make a request to the user's Firefly III URL (e.g., `GET /api/v1/accounts?type=asset`) using the decrypted token.
        *   Return the response from Firefly III.
2.  **Frontend: Fetch Data for Dropdowns (AC: 5, 6)**
    *   [ ] In `TransactionTable.tsx`, use a data fetching hook (`swr` or `react-query`) to call the new `/api/v1/firefly/accounts` and `/api/v1/firefly/categories` endpoints when the component mounts.
    *   [ ] Store the fetched data in the component's state.
    *   [ ] Pass the fetched data as options to the `Select` components in the grid columns.
3.  **Frontend: Handle Mapping Selection (AC: 7)**
    *   [ ] Update the `processRowUpdate` function in the Data Grid.
    *   [ ] When a mapping dropdown is changed, ensure the new value (e.g., `category_id`) is included in the `user_mappings` object.
    *   [ ] Send the updated `user_mappings` object in the `PUT` request to `/staged-transactions/{transactionId}`.
4.  **Write Tests**
    *   [ ] Implement backend unit tests for the proxy endpoints.
    *   [ ] Implement frontend unit tests for fetching and displaying the mapping data, and for saving a user's selection.

### 5. QA Results
*   *Pending*
