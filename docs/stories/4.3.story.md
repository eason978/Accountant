---
epic: 4
story-id: 3
title: "Apply Mapping Rules During Processing"
status: "Draft"
---

### 1. Story

As the system, when processing a new document, I want to automatically apply the user's saved mapping rules to the newly parsed transactions, so that the user has less manual work to do.

### 2. Acceptance Criteria

1.  The background job processing logic (from Story 2.4) is modified.
2.  After transactions are parsed from OCR but before they are saved, the system fetches all `MappingRule`s for the user who owns the job.
3.  For each parsed transaction, the system iterates through the user's rules.
4.  If a rule's `trigger_keyword` is found within the transaction's `description`, the rule's `target_category_id` and/or `target_destination_account_id` are automatically applied to the `user_mappings` field of the `StagedTransaction`.
5.  The `StagedTransaction` is then saved to the database with these pre-filled mappings.
6.  If multiple rules match, the first one found can take precedence.

### 3. Dev Notes

#### Previous Story Insights
*   This is a backend-only story. It modifies the background task implemented in Story 2.4.

#### Data Models
*   **`MappingRule`**: The system will read from this table to get the rules.
*   **`StagedTransaction`**: The system will pre-populate the `user_mappings` field of records in this table based on the rules.

#### API Specifications
*   No public-facing APIs are changed in this story. All changes are to the internal background processing logic.

#### Component Specifications
*   No frontend components are changed. The results of this story will be visible on the `TransactionTable` component, where some transactions will appear with pre-filled mappings.

#### File Locations
*   **Backend Logic**: The primary changes will be in the background task handler (`apps/api/routers/internal.py`) and the parsing service (`apps/api/services/parser.py`) from Story 2.4.

#### Testing Requirements
*   **Backend (Pytest)**:
    *   Update the unit tests for the background job processor.
    *   Create a mock set of user rules.
    *   Provide sample parsed transactions.
    *   Verify that transactions with matching keywords get their `user_mappings` correctly pre-populated.
    *   Verify that transactions with no matching keywords have empty mappings.

### 4. Tasks / Subtasks

1.  **Backend: Modify Job Processor (AC: 1, 2)**
    *   [ ] In the background task handler, after fetching the `ImportJob` record, add a step to fetch all `MappingRule`s associated with the `user_id`.
2.  **Backend: Implement Rule Application Logic (AC: 3, 4, 5, 6)**
    *   [ ] In the service responsible for parsing OCR text (`parser.py`), pass in the user's list of rules.
    *   [ ] After a transaction is parsed into a raw object but before it's saved, loop through the rules.
    *   [ ] Perform a case-insensitive check to see if a rule's `trigger_keyword` exists in the transaction's `description`.
    *   [ ] If a match is found, apply the target IDs from the rule to the `user_mappings` field of the transaction object.
    *   [ ] Save the transaction object (now with potential pre-filled mappings) to the database.
3.  **Write Tests (AC: 1-6)**
    *   [ ] Update the Pytest tests for the background job to include test cases for rule application.

### 5. QA Results
*   *Pending*
