---
epic: 2
story-id: 4
title: "Background Document Parsing and OCR"
status: "Draft"
---

### 1. Story

As the system, once a background job is triggered, I need to download the associated file, perform Optical Character Recognition (OCR) on it, and save the extracted transactions to the database for the user to review.

### 2. Acceptance Criteria

1.  A new, internal-only backend endpoint is created to be the target for GCP Cloud Tasks.
2.  When triggered, the endpoint retrieves the `import_job_id` from the task payload.
3.  The system updates the `ImportJob` status to 'parsing'.
4.  The system downloads the file from Supabase Storage using the `file_path` from the `ImportJob` record.
5.  The system sends the file content to the Google Cloud Vision API for OCR processing.
6.  The system receives the parsed text from the Vision API.
7.  The system processes the raw text, attempting to identify and structure individual transactions (date, description, amount).
8.  For each identified transaction, a new record is created in the `staged_transactions` table, linked to the `import_job_id`.
9.  After all transactions are saved, the `ImportJob` status is updated to 'pending_review'.
10. If any step fails, the `ImportJob` status is updated to 'failed' and an `error_message` is recorded.

### 3. Dev Notes

#### Previous Story Insights
*   This story implements the second half of the asynchronous workflow initiated in Story 2.3.

#### Data Models
*   **`ImportJob`**: This story heavily involves updating the `status` and `error_message` fields of this model.
*   **`StagedTransaction`**: The primary output of this story is creating new records in this table.
    *   `[Source: architecture.md#4.2 Model: ImportJob]`
    *   `[Source: architecture.md#4.3 Model: StagedTransaction]`

#### API Specifications
*   **Internal Task Handler Endpoint**: A new, non-public endpoint (e.g., `POST /api/v1/internal/process-job`) must be created. It should be protected from public access (e.g., by checking for a specific header sent by GCP Cloud Tasks).
*   **Google Cloud Vision API**: The backend will need to interact with this API. The client library for GCP should be used.
    *   `[Source: architecture.md#7.2 API: Google Cloud Vision API]`

#### Component Specifications
*   This is a backend-only story. No new UI components are created. The results of this story will be visible through the UI built in Story 2.1.

#### File Locations
*   **Backend API Endpoint**: A new internal router, e.g., `apps/api/routers/internal.py`.
*   **Backend Logic**: 
    *   A service for interacting with Google Cloud Vision, e.g., `apps/api/services/ocr.py`.
    *   A service for parsing the OCR text into structured transactions, e.g., `apps/api/services/parser.py`.
    *   The main logic will reside in the new internal endpoint handler.

#### Testing Requirements
*   **Backend (Pytest)**:
    *   Unit test the new internal endpoint.
    *   Mock the interactions with Supabase Storage (downloading file) and Google Cloud Vision API.
    *   Provide sample OCR output and test the `parser` service to ensure it correctly extracts transactions.
    *   Test the success case: verify that `StagedTransaction` records are created and the `ImportJob` status is updated to `pending_review`.
    *   Test failure cases: Vision API error, file not found, parsing error. Verify the `ImportJob` status is updated to `failed` with a message.

### 4. Tasks / Subtasks

1.  **Backend: Create Internal Task Handler Endpoint (AC: 1, 2)**
    *   [ ] Create a new router and endpoint (e.g., `POST /internal/process-job`).
    *   [ ] Implement security to ensure it can only be called by GCP Cloud Tasks.
    *   [ ] The endpoint should extract the `import_job_id` from the request body.
2.  **Backend: Implement File Handling (AC: 3, 4)**
    *   [ ] Fetch the `ImportJob` record from the database.
    *   [ ] Update the job status to 'parsing'.
    *   [ ] Using the `file_path`, download the file from Supabase Storage.
3.  **Backend: Implement OCR Integration (AC: 5, 6)**
    *   [ ] Add the GCP Vision client library to dependencies.
    *   [ ] Create a service to encapsulate the call to the Vision API.
    *   [ ] Send the file content to the Vision API and await the parsed text result.
4.  **Backend: Implement Transaction Parsing (AC: 7, 8)**
    *   [ ] Create a `parser` service that takes the raw OCR text as input.
    *   [ ] Implement logic (e.g., using regular expressions) to find and extract transaction-like lines from the text.
    *   [ ] For each extracted line, create a `StagedTransaction` object and save it to the database.
5.  **Backend: Finalize Job Status (AC: 9, 10)**
    *   [ ] If all steps are successful, update the `ImportJob` status to `pending_review`.
    *   [ ] Wrap the entire process in a try/except block. On any failure, update the `ImportJob` status to `failed` and record the exception message.
6.  **Write Tests**
    *   [ ] Implement backend unit tests covering the full success and failure paths of the job processing logic.

### 5. QA Results
*   *Pending*
