---
epic: 3
story-id: 2
title: "Inline Editing of Staged Transactions"
status: "Draft"
---

### 1. Story

As a user on the review screen, I want to be able to edit the date, description, and amount for each staged transaction, so that I can correct any parsing errors.

### 2. Acceptance Criteria

1.  The `transaction_date`, `description`, and `amount` cells in the `TransactionTable` component are editable.
2.  When a user finishes editing a cell, the frontend automatically calls a new backend endpoint to save the change.
3.  A new backend endpoint `PUT /api/v1/staged-transactions/{transactionId}` is created to handle updates to a single transaction.
4.  The backend endpoint updates the specified field(s) on the `StagedTransaction` record in the database.
5.  The UI provides clear feedback that the row has been successfully updated (e.g., a brief highlight or an icon).
6.  If the update fails, an error message is shown to the user.

### 3. Dev Notes

#### Previous Story Insights
*   This story adds functionality directly to the `TransactionTable.tsx` component created in Story 3.1.

#### Data Models
*   **`StagedTransaction`**: This story involves updating records in this table.
    *   `[Source: architecture.md#4.3 Model: StagedTransaction]`

#### API Specifications
*   **`PUT /api/v1/staged-transactions/{transactionId}`**: This new endpoint must be implemented. It should accept a payload containing the fields to be updated.
    *   The endpoint must be secured, ensuring a user can only edit transactions belonging to their own import jobs.
    *   `[Source: architecture.md#5.1 REST API Specification (OpenAPI)]`

#### Component Specifications
*   **TransactionTable**: The MUI Data Grid component will be configured to enable editing.
    *   The `editMode="row"` or `editMode="cell"` prop can be used.
    *   A callback function like `processRowUpdate` will be implemented to handle the API call when an edit is committed.
    *   `[Source: front-end-spec.md#4.1 Key Screen Layouts]` (Specifically, the note about fields being editable).

#### File Locations
*   **Frontend Component**: `apps/web/src/components/review/TransactionTable.tsx` will be modified.
*   **Backend API Endpoint**: A new router `apps/api/routers/staged_transactions.py` should be created to house the new `PUT` endpoint.

#### Testing Requirements
*   **Backend (Pytest)**:
    *   Write unit tests for the `PUT /{transactionId}` endpoint.
    *   Test that it correctly updates a transaction for a valid ID and authorized user.
    *   Test that it returns an error for an invalid ID or unauthorized user.
*   **Frontend (Jest/RTL)**:
    *   Update tests for `TransactionTable.tsx`.
    *   Simulate editing a cell in the data grid.
    *   Verify that the update API is called with the correct data.
    *   Test the success and error feedback mechanisms.

### 4. Tasks / Subtasks

1.  **Backend: Create API Endpoint (AC: 3, 4)**
    *   [ ] Create a new router file for `staged-transactions`.
    *   [ ] Implement the `PUT /{transactionId}` endpoint.
    *   [ ] The endpoint should accept a Pydantic model with the updatable fields.
    *   [ ] Add logic to update the `staged_transactions` record in Supabase, ensuring the user is authorized.
2.  **Frontend: Enable Grid Editing (AC: 1, 2)**
    *   [ ] In `TransactionTable.tsx`, configure the MUI Data Grid to be editable.
    *   [ ] Define which columns (`date`, `description`, `amount`) are editable.
3.  **Frontend: Implement Update Logic (AC: 2, 5, 6)**
    *   [ ] Implement the `processRowUpdate` (or similar) callback on the Data Grid.
    *   [ ] Inside the callback, make a `PUT` request to the new backend endpoint with the updated row data.
    *   [ ] Handle the success case by showing a success indicator.
    *   [ ] Handle the error case by showing an error message (e.g., a Snackbar).
4.  **Write Tests**
    *   [ ] Implement backend unit tests for the new PUT endpoint.
    *   [ ] Implement frontend unit tests for the inline editing functionality.

### 5. QA Results
*   *Pending*
