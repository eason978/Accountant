---
epic: 1
story-id: 4
title: "Save and Test Firefly III Connection"
status: "Draft"
---

### 1. Story

As a user on the settings page, I want to be able to enter my Firefly III URL and Personal Access Token and have the system test the connection's validity, so that I can be sure I've provided the correct credentials before saving.

### 2. Acceptance Criteria

1.  When the user clicks the "Save & Test Connection" button, the frontend sends the credentials to the backend.
2.  The backend creates a new API endpoint `POST /api/v1/firefly/connection` to receive the credentials.
3.  The backend attempts to connect to the user-provided Firefly III URL using the provided token (e.g., by calling the `/api/v1/about` endpoint on the user's instance).
4.  If the connection is successful, the backend encrypts the access token and saves the URL and encrypted token in the `firefly_connections` table.
5.  If the connection is successful, the backend returns a `200 OK` status, and the frontend displays a "Connection successful" message.
6.  If the connection fails, the backend does NOT save the credentials and returns an appropriate error status (e.g., `400 Bad Request`) with a reason.
7.  If the connection fails, the frontend displays a specific error message, such as "Invalid URL" or "Invalid Access Token".

### 3. Dev Notes

#### Previous Story Insights
*   This story adds logic to the UI created in Story 1.3.

#### Data Models
*   **`FireflyConnection`**: The backend logic will now write to this table. The `encrypted_access_token` field is critical. A library for symmetric encryption (like `cryptography` for Python) will be needed.
    *   `[Source: architecture.md#4.4 Model: FireflyConnection]`

#### API Specifications
*   A new backend endpoint must be created as specified in the architecture:
    *   **`POST /api/v1/firefly/connection`**: This is the core of this story.
    *   The backend will act as a proxy to test the connection, it should not expose the user's token in any logs.
    *   The backend needs a secret key for encrypting and decrypting the user's token. This should be managed via environment variables, not hardcoded.
    *   `[Source: architecture.md#5.1 REST API Specification (OpenAPI)]`

#### Component Specifications
*   **Settings Form**: The `FireflyConnectionForm.tsx` component from Story 1.3 will be updated.
    *   State management will be added to handle the form inputs, loading state during the test, and success/error messages.
    *   An `onSubmit` handler will be implemented to call our new backend API endpoint.
    *   `[Source: front-end-spec.md#4.1 Key Screen Layouts]`

#### File Locations
*   **Backend API Endpoint**: A new router or function should be added in `apps/api`, for example in `apps/api/routers/firefly.py`.
*   **Backend Logic**: Logic for testing the connection, encrypting the token, and saving to the database should be implemented.
*   **Frontend Component**: `apps/web/src/components/settings/FireflyConnectionForm.tsx` will be modified to include the API call logic.

#### Testing Requirements
*   **Backend (Pytest)**:
    *   Write unit tests for the `POST /firefly/connection` endpoint.
    *   Mock the external call to the user's Firefly III instance.
    *   Test the success case: verify the token is encrypted and data is saved.
    *   Test failure cases: invalid URL, invalid token, etc.
*   **Frontend (Jest/RTL)**:
    *   Update tests for `FireflyConnectionForm.tsx`.
    *   Mock the backend API call.
    *   Test that a successful response displays a success message.
    *   Test that a failed response displays an error message.

### 4. Tasks / Subtasks

1.  **Backend: Create API Endpoint (AC: 2)**
    *   [ ] In the FastAPI app, create a new router for `/firefly`.
    *   [ ] Define the `POST /connection` endpoint, accepting a Pydantic model with `firefly_url` and `access_token`.
2.  **Backend: Implement Connection Logic (AC: 3, 6)**
    *   [ ] Add logic to the endpoint to make an external `GET` request to the provided `firefly_url` + `/api/v1/about`.
    *   [ ] Handle potential exceptions (e.g., invalid URL, request timeout, non-200 status code from Firefly III) and return appropriate error responses.
3.  **Backend: Implement Encryption & Storage (AC: 4)**
    *   [ ] Add an encryption utility (e.g., using the `cryptography` library).
    *   [ ] Load a secret encryption key from an environment variable.
    *   [ ] On successful connection, encrypt the received `access_token`.
    *   [ ] Write the `user_id`, `firefly_url`, and `encrypted_access_token` to the `firefly_connections` table in Supabase.
4.  **Frontend: Implement API Call (AC: 1, 5, 7)**
    *   [ ] In `FireflyConnectionForm.tsx`, add state for loading and error/success messages.
    *   [ ] Implement the `onSubmit` function to make a `POST` request to `/api/v1/firefly/connection` with the form data.
    *   [ ] On success, display a success message (e.g., using a Snackbar).
    *   [ ] On failure, display the error message returned from the backend.
5.  **Write Tests (AC: 1-7)**
    *   [ ] Implement backend unit tests for the new endpoint and logic.
    *   [ ] Implement frontend unit tests for the updated form component.

### 5. QA Results
*   *Pending*
