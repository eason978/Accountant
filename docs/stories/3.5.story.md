---
epic: 3
story-id: 5
title: "Batch Mapping for Transactions"
status: "Draft"
---

### 1. Story

As a user, I want to be able to select multiple transactions and apply a single category or account to all of them at once, so that I can work more efficiently.

### 2. Acceptance Criteria

1.  The `TransactionTable` data grid has checkboxes on each row, allowing for multi-row selection.
2.  When one or more rows are selected, a "Batch Actions" UI section becomes visible.
3.  This UI section contains a dropdown to select a field to update (e.g., "Category", "Source Account") and another dropdown to select the value.
4.  An "Apply to Selected" button is present.
5.  When the user clicks the apply button, the frontend iterates through all selected row IDs and calls the `PUT /staged-transactions/{transactionId}` endpoint for each one, updating the chosen mapping field.
6.  The UI optimistically updates all selected rows to show the new value, and provides a success message once all API calls are complete.

### 3. Dev Notes

#### Previous Story Insights
*   This is a frontend-heavy feature that builds on the components and APIs from stories 3.1 through 3.4. It reuses the existing `PUT` endpoint.

#### API Specifications
*   No new backend APIs are required. This story will make multiple calls to the existing `PUT /api/v1/staged-transactions/{transactionId}` endpoint.

#### Component Specifications
*   **TransactionTable**: The MUI Data Grid will be configured to enable checkbox selection.
    *   The `checkboxSelection` prop should be set to `true`.
    *   The component will need to manage the state of selected row IDs.
*   **BatchActions**: A new component, perhaps displayed above the grid, that contains the UI for batch actions. It will be conditionally rendered based on whether any rows are selected.
    *   `[Source: front-end-spec.md#4.1 Key Screen Layouts]` (Specifically, the mention of batch processing features).

#### File Locations
*   **Frontend Component**: `apps/web/src/components/review/TransactionTable.tsx` will be modified to enable selection.
*   **New Frontend Component**: `apps/web/src/components/review/BatchActions.tsx` will be created.
*   **Frontend Page**: `apps/web/src/app/jobs/[jobId]/page.tsx` will be updated to include the new `BatchActions` component.

#### Testing Requirements
*   **Frontend (Jest/RTL)**:
    *   Update tests for `TransactionTable.tsx` to handle row selection.
    *   Create new tests for the `BatchActions.tsx` component.
    *   Simulate selecting multiple rows, choosing an action, and clicking apply.
    *   Verify that the `PUT` API call is made for each selected row with the correct payload.

### 4. Tasks / Subtasks

1.  **Frontend: Enable Row Selection (AC: 1)**
    *   [ ] In `TransactionTable.tsx`, configure the MUI Data Grid to support checkbox-based row selection.
    *   [ ] Add state management to track the list of selected transaction IDs.
2.  **Frontend: Create Batch Actions UI (AC: 2, 3, 4)**
    *   [ ] Create the `BatchActions.tsx` component.
    *   [ ] This component should accept the list of available accounts and categories as props to populate its own dropdowns.
    *   [ ] It should be hidden by default and only appear when the number of selected rows is greater than zero.
3.  **Frontend: Implement Batch Update Logic (AC: 5, 6)**
    *   [ ] In the `BatchActions.tsx` component, implement the `onClick` handler for the apply button.
    *   [ ] The handler should get the list of selected transaction IDs.
    *   [ ] It should then loop through the IDs and fire off a `PUT` request to `/staged-transactions/{id}` for each one.
    *   [ ] Use `Promise.all` to wait for all API calls to complete.
    *   [ ] After successful completion, trigger a re-fetch of the main transaction list to show the updated data and display a success message.
4.  **Write Tests**
    *   [ ] Implement frontend unit tests for the new batch action functionality.

### 5. QA Results
*   *Pending*
