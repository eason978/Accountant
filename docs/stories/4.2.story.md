---
epic: 4
story-id: 2
title: "Create a New Mapping Rule"
status: "Draft"
---

### 1. Story

As a user, I want to create a new mapping rule by specifying a keyword and a target Firefly III category or account, so that future transactions can be mapped automatically.

### 2. Acceptance Criteria

1.  A "Create New Rule" form or button is present in the "My Rules" section of the settings page.
2.  The form includes inputs for a `name` (for the user to identify the rule), a `trigger_keyword`, and optional dropdowns for `target_category_id` and `target_destination_account_id`.
3.  The category and account dropdowns are populated with data from the existing Firefly III proxy endpoints (`GET /firefly/accounts`, `GET /firefly/categories`).
4.  A new backend endpoint `POST /api/v1/mapping-rules` is created.
5.  Submitting the form calls the `POST` endpoint, which creates a new `MappingRule` record in the database linked to the user.
6.  Upon successful creation, the new rule is added to the list of rules displayed on the UI.

### 3. Dev Notes

#### Previous Story Insights
*   This story adds the "create" part to the CRUD functionality for mapping rules, building on the UI from Story 4.1.

#### Data Models
*   **`MappingRule`**: The `POST` endpoint will create a new record in this table.
    *   `[Source: architecture.md#4.5 Model: MappingRule]`

#### API Specifications
*   **`POST /mapping-rules`**: This new endpoint is the core of the story. It will accept a payload with the rule details and create a new record.
    *   `[Source: architecture.md#5.1 REST API Specification (OpenAPI)]`

#### Component Specifications
*   **Create Rule Form**: A new component for the form to create a rule.
    *   It will reuse the Firefly III data fetching logic from the `TransactionTable` to populate its own dropdowns.
    *   It will have its own state management for the form fields.

#### File Locations
*   **New Frontend Component**: `apps/web/src/components/settings/CreateRuleForm.tsx`.
*   **Frontend Page**: `apps/web/src/app/settings/page.tsx` will be updated to include the new form component.
*   **Backend API Endpoint**: `apps/api/routers/mapping_rules.py` will be updated to include the `POST` endpoint.

#### Testing Requirements
*   **Backend (Pytest)**:
    *   Write unit tests for the `POST /mapping-rules` endpoint.
    *   Verify that a new rule is created with the correct data and user ID.
*   **Frontend (Jest/RTL)**:
    *   Test the `CreateRuleForm` component.
    *   Test form submission and that the correct payload is sent to the API.
    *   Test that the rule list is updated after successful creation.

### 4. Tasks / Subtasks

1.  **Backend: Create API Endpoint (AC: 4, 5)**
    *   [ ] In `apps/api/routers/mapping_rules.py`, implement the `POST /` endpoint.
    *   [ ] The endpoint should accept a Pydantic model with the rule data.
    *   [ ] It should create a new `MappingRule` record in the database.
2.  **Frontend: Create Form Component (AC: 1, 2, 3)**
    *   [ ] Create the `CreateRuleForm.tsx` component.
    *   [ ] Add MUI `TextField` and `Select` components for the rule fields.
    *   [ ] Fetch data from the Firefly III proxy endpoints to populate the `Select` options.
3.  **Frontend: Implement Form Logic (AC: 5, 6)**
    *   [ ] Implement the `onSubmit` handler for the form.
    *   [ ] On submit, call the `POST /api/v1/mapping-rules` endpoint.
    *   [ ] On success, clear the form and trigger a refetch of the rules list in the `MappingRulesList` component.
4.  **Frontend: Integrate into Settings Page (AC: 1)**
    *   [ ] Add the `CreateRuleForm` to the `settings` page, likely near the `MappingRulesList`.
5.  **Write Tests**
    *   [ ] Implement backend unit tests for the new POST endpoint.
    *   [ ] Implement frontend unit tests for the new form component.

### 5. QA Results
*   *Pending*
